<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ - GitHub Action Executor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ –í—ã–±–æ—Ä —Ç–µ—Å—Ç–æ–≤</h1>
            <p class="subtitle">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: <strong>{{ owner }}/{{ repo }}</strong></p>
            <p class="subtitle">Workflow: <strong>{{ workflow_id }}</strong></p>
        </header>

        <div class="user-info">
            <img src="{{ user.avatar_url }}" alt="{{ user.login }}" class="avatar">
            <span>{{ user.login }}</span>
            <a href="/" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
        </div>

        <main>
            <form id="testForm" action="/workflow/trigger" method="post" class="test-form">
                <input type="hidden" name="owner" value="{{ owner }}">
                <input type="hidden" name="repo" value="{{ repo }}">
                
                <div class="form-group">
                    <label for="workflow_id">Workflow:</label>
                    <div class="searchable-select-wrapper">
                        <input type="text" 
                               id="workflow_search" 
                               class="searchable-select-input" 
                               placeholder="–ü–æ–∏—Å–∫ workflow..." 
                               autocomplete="off">
                        <select id="workflow_id" name="workflow_id" class="searchable-select" required>
                            {% if workflows and workflows|length > 0 %}
                                {% for workflow in workflows %}
                                    <option value="{{ workflow.id }}" 
                                            data-name="{{ workflow.name }}"
                                            {% if workflow.id == workflow_id %}selected{% endif %}>
                                        {{ workflow.id }} - {{ workflow.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="{{ workflow_id or '' }}" selected>{{ workflow_id or '–í—ã–±–µ—Ä–∏—Ç–µ workflow' }}</option>
                            {% endif %}
                        </select>
                        <div class="searchable-select-dropdown" id="workflow_dropdown"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ref">–í–µ—Ç–∫–∞:</label>
                    <div class="searchable-select-wrapper">
                        <input type="text" 
                               id="branch_search" 
                               class="searchable-select-input" 
                               placeholder="–ü–æ–∏—Å–∫ –≤–µ—Ç–∫–∏..." 
                               autocomplete="off">
                        <select id="ref" name="ref" class="searchable-select" required>
                            {% if branches and branches|length > 0 %}
                                {% for branch in branches %}
                                    <option value="{{ branch }}" 
                                            {% if branch == ref or (not ref and branch == 'main') %}selected{% endif %}>
                                        {{ branch }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="{{ ref or 'main' }}" selected>{{ ref or 'main' }}</option>
                            {% endif %}
                        </select>
                        <div class="searchable-select-dropdown" id="branch_dropdown"></div>
                    </div>
                </div>


                {% if inputs_schema %}
                    {% if inputs_schema|length > 0 %}
                    {# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ workflow inputs #}
                    {% for input_name, input_config in inputs_schema.items() %}
                        <div class="form-group">
                            <label for="input_{{ input_name }}">
                                {% set field_label = input_config.get('description', '') %}
                                {% if field_label %}
                                    {{ field_label }}
                                {% else %}
                                    {{ input_name|replace('_', ' ')|title }}
                                {% endif %}
                                {% if input_config.get('required', False) %}
                                    <span class="required">*</span>
                                {% endif %}
                            </label>
                            
                            {% if input_config.get('type') == 'choice' %}
                                {# Select –¥–ª—è choice #}
                                <select id="input_{{ input_name }}" name="{{ input_name }}" 
                                        {% if input_config.get('required', False) %}required{% endif %}
                                        class="form-select">
                                    {% if not input_config.get('required', False) %}
                                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                                    {% endif %}
                                    {% for option in input_config.get('options', []) %}
                                        <option value="{{ option }}" 
                                                {% if option == input_config.get('default') %}selected{% endif %}>
                                            {{ option }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% elif input_config.get('type') == 'boolean' %}
                                {# Checkbox –¥–ª—è boolean #}
                                <label class="checkbox-label">
                                    <input type="checkbox" id="input_{{ input_name }}" name="{{ input_name }}" 
                                           value="true"
                                           {% if input_config.get('default', False) %}checked{% endif %}>
                                    <span>{{ input_config.get('description', input_name) }}</span>
                                </label>
                            {% elif input_config.get('type') == 'environment' %}
                                {# Select –¥–ª—è environment #}
                                <select id="input_{{ input_name }}" name="{{ input_name }}" 
                                        {% if input_config.get('required', False) %}required{% endif %}
                                        class="form-select">
                                    {% if not input_config.get('required', False) %}
                                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                                    {% endif %}
                                    {% for env in ['production', 'staging', 'development', 'test'] %}
                                        <option value="{{ env }}" 
                                                {% if env == input_config.get('default') %}selected{% endif %}>
                                            {{ env }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                {# Text input –¥–ª—è string –∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ #}
                                {% set field_placeholder = input_config.get('description', '') %}
                                {% if not field_placeholder %}
                                    {% set field_placeholder = input_name|replace('_', ' ')|title %}
                                {% endif %}
                                <input type="text" 
                                       id="input_{{ input_name }}" 
                                       name="{{ input_name }}" 
                                       value="{{ input_config.get('default', '') }}"
                                       placeholder="{{ field_placeholder }}"
                                       {% if input_config.get('required', False) %}required{% endif %}
                                       class="form-input">
                            {% endif %}
                        </div>
                    {% endfor %}
                    {% else %}
                        {# inputs_schema —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—É—Å—Ç–æ–π #}
                        <div class="info-section">
                            <p>Workflow –Ω–∞–π–¥–µ–Ω, –Ω–æ –≤ –Ω–µ–º –Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö inputs –≤ workflow_dispatch.</p>
                        </div>
                    {% endif %}
                {% else %}
                    {# –ï—Å–ª–∏ workflow info –Ω–µ –ø–æ–ª—É—á–µ–Ω –∏–ª–∏ inputs –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏—á–µ–≥–æ #}
                    {% if not workflow_info %}
                        <div class="info-section">
                            <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ workflow. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL.</p>
                        </div>
                    {% elif workflow_info.get('found') and inputs_schema|length == 0 %}
                        <div class="info-section">
                            <p>Workflow –Ω–∞–π–¥–µ–Ω, –Ω–æ –≤ –Ω–µ–º –Ω–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö inputs –≤ workflow_dispatch.</p>
                        </div>
                    {% endif %}
                {% endif %}

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Workflow
                </button>
            </form>
        </main>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ —Å –ø–æ–∏—Å–∫–æ–º
        function initSearchableSelect(searchInputId, selectId, dropdownId) {
            const searchInput = document.getElementById(searchInputId);
            const select = document.getElementById(selectId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!searchInput || !select || !dropdown) return;
            
            // –°–æ–∑–¥–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è dropdown
            function buildDropdown() {
                dropdown.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                const options = Array.from(select.options);
                
                options.forEach(function(option) {
                    if (option.value === '') return;
                    
                    const text = option.textContent.toLowerCase();
                    const matches = searchTerm === '' || text.includes(searchTerm);
                    
                    const div = document.createElement('div');
                    div.className = 'searchable-select-option' + (matches ? '' : ' hidden');
                    if (option.selected) {
                        div.classList.add('selected');
                    }
                    div.textContent = option.textContent;
                    div.dataset.value = option.value;
                    
                    div.addEventListener('click', function() {
                        select.value = option.value;
                        searchInput.value = option.textContent;
                        dropdown.classList.remove('show');
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        dropdown.querySelectorAll('.searchable-select-option').forEach(function(opt) {
                            opt.classList.remove('selected');
                        });
                        div.classList.add('selected');
                    });
                    
                    dropdown.appendChild(div);
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            if (select.selectedIndex >= 0) {
                searchInput.value = select.options[select.selectedIndex].textContent;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞
            searchInput.addEventListener('focus', function() {
                buildDropdown();
                dropdown.classList.add('show');
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
            searchInput.addEventListener('input', function() {
                buildDropdown();
                dropdown.classList.add('show');
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ select
                    if (select.selectedIndex >= 0) {
                        searchInput.value = select.options[select.selectedIndex].textContent;
                    }
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
                    e.preventDefault();
                    const visibleOptions = dropdown.querySelectorAll('.searchable-select-option:not(.hidden)');
                    if (visibleOptions.length === 0) return;
                    
                    let selectedIndex = -1;
                    visibleOptions.forEach(function(opt, index) {
                        if (opt.classList.contains('selected')) {
                            selectedIndex = index;
                        }
                    });
                    
                    if (e.key === 'ArrowDown') {
                        selectedIndex = (selectedIndex + 1) % visibleOptions.length;
                    } else if (e.key === 'ArrowUp') {
                        selectedIndex = selectedIndex <= 0 ? visibleOptions.length - 1 : selectedIndex - 1;
                    } else if (e.key === 'Enter') {
                        if (selectedIndex >= 0) {
                            visibleOptions[selectedIndex].click();
                            return;
                        }
                    }
                    
                    visibleOptions.forEach(function(opt) {
                        opt.classList.remove('selected');
                    });
                    if (selectedIndex >= 0) {
                        visibleOptions[selectedIndex].classList.add('selected');
                        visibleOptions[selectedIndex].scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    searchInput.blur();
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
            initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ workflow
            const workflowSelect = document.getElementById('workflow_id');
            if (workflowSelect) {
                workflowSelect.addEventListener('change', function() {
                    const form = document.getElementById('testForm');
                    const owner = form.querySelector('input[name="owner"]').value;
                    const repo = form.querySelector('input[name="repo"]').value;
                    const workflowId = this.value;
                    const ref = document.getElementById('ref').value;
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º workflow_id
                    window.location.href = `/workflow/form?owner=${owner}&repo=${repo}&workflow_id=${workflowId}&ref=${ref}`;
                });
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('testForm').addEventListener('submit', function(e) {
            const form = e.target;
            const submitBtn = document.getElementById('submitBtn');
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤ tests (–¥–ª—è fallback —Ä–µ–∂–∏–º–∞)
            const testsCheckboxes = form.querySelectorAll('input[name="tests"][type="checkbox"]');
            if (testsCheckboxes.length > 0) {
                const selectedTests = [];
                testsCheckboxes.forEach(function(checkbox) {
                    if (checkbox.checked) {
                        selectedTests.push(checkbox.value);
                    }
                    checkbox.disabled = true;
                });
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è tests (–µ—Å–ª–∏ –µ—Å—Ç—å)
                form.querySelectorAll('input[name="tests"][type="hidden"]').forEach(function(input) {
                    input.remove();
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å–æ —Å—Ç—Ä–æ–∫–æ–π —Ç–µ—Å—Ç–æ–≤
                if (selectedTests.length > 0) {
                    const testsInput = document.createElement('input');
                    testsInput.type = 'hidden';
                    testsInput.name = 'tests';
                    testsInput.value = selectedTests.join(',');
                    form.appendChild(testsInput);
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ boolean –ø–æ–ª–µ–π - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
            form.querySelectorAll('input[type="checkbox"][name!="tests"]').forEach(function(checkbox) {
                if (!checkbox.checked) {
                    // –î–ª—è –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö boolean —Å–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º false
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = checkbox.name;
                    hiddenInput.value = 'false';
                    form.appendChild(hiddenInput);
                } else {
                    checkbox.value = 'true';
                }
            });
            
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫ workflow...';
        });
    </script>
</body>
</html>

