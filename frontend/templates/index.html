<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Action Executor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ GitHub Action Executor</h1>
            <p class="subtitle">–ó–∞–ø—É—Å–∫ GitHub Actions workflows —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤</p>
        </header>

        <div class="auth-section">
            {% if user %}
                <div class="user-info">
                    <img src="{{ user.avatar_url }}" alt="{{ user.login }}" class="avatar">
                    <span>–ü—Ä–∏–≤–µ—Ç, <strong>{{ user.login }}</strong>!</span>
                    <a href="/auth/logout" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
                </div>
            {% else %}
                <div class="login-prompt">
                    <p>–î–ª—è –∑–∞–ø—É—Å–∫–∞ workflow –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ GitHub</p>
                    <a href="/auth/github" class="btn btn-primary">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ GitHub</a>
                </div>
            {% endif %}
        </div>

        {% if user %}
        <main>
            <div class="form-container">
                <form id="workflowForm" action="/workflow/trigger" method="post" class="workflow-form">
                    <div class="form-group">
                        <label for="owner">–í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</label>
                        <input type="text" id="owner" name="owner" 
                               value="{{ default_owner or '' }}" 
                               placeholder="username –∏–ª–∏ organization" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="repo">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</label>
                        <input type="text" id="repo" name="repo" 
                               value="{{ default_repo or '' }}" 
                               placeholder="repo-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="workflow_id">Workflow:</label>
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="workflow_search" 
                                   class="searchable-select-input" 
                                   placeholder="{% if workflows and workflows|length > 0 %}–ü–æ–∏—Å–∫ workflow... ({{ workflows|length }} –¥–æ—Å—Ç—É–ø–Ω–æ){% else %}–í–≤–µ–¥–∏—Ç–µ workflow ID{% endif %}" 
                                   autocomplete="off"
                                   value="{% if default_workflow_id %}{{ default_workflow_id }}{% endif %}">
                            <select id="workflow_id" name="workflow_id" class="searchable-select" required>
                                {% if workflows and workflows|length > 0 %}
                                    {% for workflow in workflows %}
                                        <option value="{{ workflow.id }}" 
                                                data-name="{{ workflow.name }}"
                                                {% if workflow.id == default_workflow_id %}selected{% endif %}>
                                            {{ workflow.id }} - {{ workflow.name }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="{{ default_workflow_id or '' }}" selected>{{ default_workflow_id or '–í—ã–±–µ—Ä–∏—Ç–µ workflow' }}</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="workflow_dropdown"></div>
                        </div>
                        {% if not workflows or workflows|length == 0 %}
                            <small style="color: #666; font-size: 0.7em;">–í–≤–µ–¥–∏—Ç–µ owner –∏ repo, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ workflows</small>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="ref">–í–µ—Ç–∫–∞:</label>
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="branch_search" 
                                   class="searchable-select-input" 
                                   placeholder="{% if branches and branches|length > 0 %}–ü–æ–∏—Å–∫ –≤–µ—Ç–∫–∏... ({{ branches|length }} –¥–æ—Å—Ç—É–ø–Ω–æ){% else %}–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏{% endif %}" 
                                   autocomplete="off"
                                   value="{% if branches and branches|length > 0 %}main{% else %}main{% endif %}">
                            <select id="ref" name="ref" class="searchable-select">
                                {% if branches and branches|length > 0 %}
                                    {% for branch in branches %}
                                        <option value="{{ branch }}" 
                                                {% if branch == 'main' %}selected{% endif %}>
                                            {{ branch }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="main" selected>main</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="branch_dropdown"></div>
                        </div>
                        {% if not branches or branches|length == 0 %}
                            <small style="color: #666; font-size: 0.7em;">–í–≤–µ–¥–∏—Ç–µ owner –∏ repo, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫</small>
                        {% endif %}
                    </div>

                    {# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –¥–ª—è workflow inputs #}
                    <div id="workflow-inputs"></div>
                    
                    <button type="submit" class="btn btn-primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å Workflow</button>
                </form>
            </div>
        </main>
        {% endif %}
    </div>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ searchable select
        function initSearchableSelect(searchInputId, selectId, dropdownId) {
            const searchInput = document.getElementById(searchInputId);
            const select = document.getElementById(selectId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!searchInput || !select || !dropdown) return;
            
            function updateDropdown() {
                dropdown.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                
                Array.from(select.options).forEach(function(option) {
                    if (option.value === '') return;
                    
                    const text = option.textContent.toLowerCase();
                    const matches = searchTerm === '' || text.includes(searchTerm);
                    
                    const div = document.createElement('div');
                    div.className = 'searchable-select-option' + (matches ? '' : ' hidden');
                    if (option.selected) {
                        div.classList.add('selected');
                    }
                    div.textContent = option.textContent;
                    div.addEventListener('click', function() {
                        select.value = option.value;
                        searchInput.value = option.textContent;
                        dropdown.classList.remove('show');
                        updateDropdown();
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º workflow inputs –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ workflow
                        if (selectId === 'workflow_id') {
                            loadWorkflowInputs();
                        }
                    });
                    dropdown.appendChild(div);
                });
            }
            
            searchInput.addEventListener('focus', function() {
                updateDropdown();
                dropdown.classList.add('show');
            });
            
            searchInput.addEventListener('input', function() {
                updateDropdown();
                dropdown.classList.add('show');
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
            
            select.addEventListener('change', function() {
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption) {
                    searchInput.value = selectedOption.textContent;
                }
                if (selectId === 'workflow_id') {
                    loadWorkflowInputs();
                }
            });
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption) {
                searchInput.value = selectedOption.textContent;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ workflow inputs
        async function loadWorkflowInputs() {
            const owner = document.getElementById('owner').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const workflowId = document.getElementById('workflow_id').value.trim();
            const inputsContainer = document.getElementById('workflow-inputs');
            
            if (!owner || !repo || !workflowId || !inputsContainer) {
                inputsContainer.innerHTML = '';
                return;
            }
            
            try {
                inputsContainer.innerHTML = '<div style="padding: 5px; color: #666; font-size: 0.7em;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ workflow...</div>';
                
                const response = await fetch(`/api/workflow-info?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&workflow_id=${encodeURIComponent(workflowId)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const inputs = data.inputs || {};
                    
                    if (Object.keys(inputs).length === 0) {
                        inputsContainer.innerHTML = '';
                        return;
                    }
                    
                    let html = '';
                    for (const [inputName, inputConfig] of Object.entries(inputs)) {
                        const fieldLabel = inputConfig.description || inputName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const isRequired = inputConfig.required || false;
                        const defaultValue = inputConfig.default;
                        
                        html += '<div class="form-group">';
                        html += `<label for="input_${inputName}">${fieldLabel}${isRequired ? ' <span class="required">*</span>' : ''}</label>`;
                        
                        if (inputConfig.type === 'choice') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>';
                            }
                            for (const option of inputConfig.options || []) {
                                html += `<option value="${option}" ${option === defaultValue ? 'selected' : ''}>${option}</option>`;
                            }
                            html += '</select>';
                        } else if (inputConfig.type === 'boolean') {
                            html += `<label class="checkbox-label">`;
                            html += `<input type="checkbox" id="input_${inputName}" name="${inputName}" value="true" ${defaultValue ? 'checked' : ''}>`;
                            html += `<span>${fieldLabel}</span>`;
                            html += `</label>`;
                        } else if (inputConfig.type === 'environment') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>';
                            }
                            for (const env of ['production', 'staging', 'development', 'test']) {
                                html += `<option value="${env}" ${env === defaultValue ? 'selected' : ''}>${env}</option>`;
                            }
                            html += '</select>';
                        } else {
                            html += `<input type="text" id="input_${inputName}" name="${inputName}" value="${defaultValue || ''}" placeholder="${fieldLabel}" class="form-input" ${isRequired ? 'required' : ''}>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    inputsContainer.innerHTML = html;
                } else {
                    inputsContainer.innerHTML = '';
                }
            } catch (error) {
                console.error('Failed to load workflow inputs:', error);
                inputsContainer.innerHTML = '';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ branches –∏ workflows
        async function loadBranchesAndWorkflows(owner, repo) {
            if (!owner || !repo) return;
            
            try {
                const [branchesResponse, workflowsResponse] = await Promise.all([
                    fetch(`/api/branches?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`),
                    fetch(`/api/workflows?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`)
                ]);
                
                if (branchesResponse.ok) {
                    const branchesData = await branchesResponse.json();
                    updateSelect('ref', branchesData.branches, 'main');
                    initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
                }
                
                if (workflowsResponse.ok) {
                    const workflowsData = await workflowsResponse.json();
                    updateSelect('workflow_id', workflowsData.workflows.map(w => ({id: w.id, name: w.name})), null);
                    initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º inputs –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ workflow
                    loadWorkflowInputs();
                }
            } catch (error) {
                console.error('Failed to load branches/workflows:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è select
        function updateSelect(selectId, items, defaultValue) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '';
            
            items.forEach(function(item) {
                const option = document.createElement('option');
                if (typeof item === 'string') {
                    option.value = item;
                    option.textContent = item;
                } else {
                    option.value = item.id;
                    option.textContent = `${item.id} - ${item.name}`;
                    option.setAttribute('data-name', item.name);
                }
                if ((defaultValue && item === defaultValue) || (defaultValue && item.id === defaultValue) || (currentValue && (item === currentValue || item.id === currentValue))) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            if (!select.value && items.length > 0) {
                if (defaultValue) {
                    const defaultOption = Array.from(select.options).find(opt => opt.value === defaultValue);
                    if (defaultOption) {
                        defaultOption.selected = true;
                    } else if (select.options.length > 0) {
                        select.options[0].selected = true;
                    }
                } else if (select.options.length > 0) {
                    select.options[0].selected = true;
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initAll() {
            initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
            initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
            
            const ownerInput = document.getElementById('owner');
            const repoInput = document.getElementById('repo');
            let loadTimeout;
            
            function handleOwnerRepoChange() {
                clearTimeout(loadTimeout);
                loadTimeout = setTimeout(function() {
                    const owner = ownerInput.value.trim();
                    const repo = repoInput.value.trim();
                    if (owner && repo) {
                        loadBranchesAndWorkflows(owner, repo);
                    }
                }, 500);
            }
            
            if (ownerInput) {
                ownerInput.addEventListener('input', handleOwnerRepoChange);
                ownerInput.addEventListener('blur', handleOwnerRepoChange);
            }
            
            if (repoInput) {
                repoInput.addEventListener('input', handleOwnerRepoChange);
                repoInput.addEventListener('blur', handleOwnerRepoChange);
            }
            
            if (ownerInput && repoInput && ownerInput.value && repoInput.value) {
                loadBranchesAndWorkflows(ownerInput.value, repoInput.value);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }
    </script>
</body>
</html>
