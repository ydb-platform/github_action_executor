<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run GitHub Action</title>
    <link rel="icon" type="image/jpeg" href="/static/fav.jpeg">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        {% if not user %}
        <div class="auth-overlay">
            <div class="auth-modal">
                <h2>Authentication Required</h2>
                <p>Please sign in with GitHub to run workflows</p>
                <a href="/auth/github" class="btn btn-primary">Sign in with GitHub</a>
            </div>
        </div>
        {% endif %}

        <header>
            <h1>Run GitHub Action</h1>
            <div class="logo-container">
                <img src="/static/fav.jpeg" alt="GitHub Action" class="github-logo">
            </div>
            <p class="subtitle">Start a GitHub Actions workflow.</p>
        </header>

        {% if user %}
        <main>
            <form id="workflowForm" action="/workflow/trigger" method="post" class="workflow-form">
                <div class="form-group">
                    <div class="field-header">
                        <label for="repository">Repository</label>
                    </div>
                    <div class="searchable-select-wrapper">
                        <input type="text" 
                               id="repository" 
                               class="searchable-select-input" 
                               placeholder="owner/repo"
                               value="{% if default_owner and default_repo %}{{ default_owner }}/{{ default_repo }}{% endif %}"
                               required>
                        <select id="repository_select" class="searchable-select" style="display: none;">
                            <option value=""></option>
                        </select>
                        <div class="searchable-select-dropdown" id="repository_dropdown"></div>
                    </div>
                    <input type="hidden" id="owner" name="owner" value="{{ default_owner or '' }}">
                    <input type="hidden" id="repo" name="repo" value="{{ default_repo or '' }}">
                </div>
                
                <div class="form-group">
                    <div class="field-header">
                        <label for="branch">Branch</label>
                    </div>
                    <div class="field-with-loader">
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="branch_search" 
                                   class="searchable-select-input" 
                                   placeholder="main"
                                   value="{% if branches and branches|length > 0 %}main{% else %}main{% endif %}">
                            <select id="ref" name="ref" class="searchable-select">
                                {% if branches and branches|length > 0 %}
                                    {% for branch in branches %}
                                        <option value="{{ branch }}" {% if branch == 'main' %}selected{% endif %}>{{ branch }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="main" selected>main</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="branch_dropdown"></div>
                        </div>
                        <div id="branch-loader" class="field-loader" style="display: none;">
                            <div class="spinner-small"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="field-header">
                        <label for="workflow_id">Workflow</label>
                        <span class="optional">Optional</span>
                    </div>
                    <div class="field-with-loader">
                        <div class="searchable-select-wrapper">
                            <input type="text" 
                                   id="workflow_search" 
                                   class="searchable-select-input" 
                                   placeholder="build - Build project"
                                   value="{% if default_workflow_id %}{{ default_workflow_id }}{% endif %}">
                            <select id="workflow_id" name="workflow_id" class="searchable-select">
                                {% if workflows and workflows|length > 0 %}
                                    {% for workflow in workflows %}
                                        <option value="{{ workflow.id }}" 
                                                data-name="{{ workflow.name }}"
                                                {% if workflow.id == default_workflow_id %}selected{% endif %}>
                                            {{ workflow.id }} - {{ workflow.name }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="{{ default_workflow_id or '' }}" selected>{{ default_workflow_id or '' }}</option>
                                {% endif %}
                            </select>
                            <div class="searchable-select-dropdown" id="workflow_dropdown"></div>
                        </div>
                        <div id="workflow-loader" class="field-loader" style="display: none;">
                            <div class="spinner-small"></div>
                        </div>
                    </div>
                </div>

                {# Динамические поля для workflow inputs #}
                <div id="workflow-inputs-wrapper" style="display: none;">
                    <div id="workflow-inputs"></div>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Run workflow</button>
                    <button type="button" id="copy-run-btn" class="btn btn-secondary" style="flex: 0 0 auto; opacity: 0.6; font-size: 13px; padding: 8px 16px; border-color: #d1d5db; background: #f9fafb; color: #6b7280;">Copy run</button>
                </div>
            </form>
        </main>
        {% endif %}
    </div>
    
    <script>
        // Функция для инициализации searchable select
        function initSearchableSelect(searchInputId, selectId, dropdownId) {
            const searchInput = document.getElementById(searchInputId);
            const select = document.getElementById(selectId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!searchInput || !select || !dropdown) return;
            
            function updateDropdown() {
                dropdown.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                
                Array.from(select.options).forEach(function(option) {
                    if (option.value === '') return;
                    
                    const text = option.textContent.toLowerCase();
                    const matches = searchTerm === '' || text.includes(searchTerm);
                    
                    const div = document.createElement('div');
                    div.className = 'searchable-select-option' + (matches ? '' : ' hidden');
                    if (option.selected) {
                        div.classList.add('selected');
                    }
                    div.textContent = option.textContent;
                    div.addEventListener('click', function() {
                        select.value = option.value;
                        searchInput.value = option.textContent;
                        dropdown.classList.remove('show');
                        updateDropdown();
                        
                        // Загружаем workflow inputs при изменении workflow
                        if (selectId === 'workflow_id') {
                            loadWorkflowInputs();
                        }
                    });
                    dropdown.appendChild(div);
                });
            }
            
            searchInput.addEventListener('focus', function() {
                updateDropdown();
                dropdown.classList.add('show');
            });
            
            searchInput.addEventListener('input', function() {
                updateDropdown();
                dropdown.classList.add('show');
                
                // Если пользователь вводит текст, который точно совпадает с опцией - выбираем её
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    Array.from(select.options).forEach(function(option) {
                        if (option.value === '' || option.value === searchTerm || option.textContent.toLowerCase() === searchTerm.toLowerCase()) {
                            if (option.value === searchTerm || option.textContent.toLowerCase() === searchTerm.toLowerCase()) {
                                select.value = option.value;
                                return;
                            }
                        }
                    });
                }
            });
            
            // При потере фокуса, если значение не совпадает с опцией - оставляем как есть или сбрасываем
            searchInput.addEventListener('blur', function() {
                // Небольшая задержка, чтобы клик по опции успел сработать
                setTimeout(function() {
                    const searchTerm = searchInput.value.trim();
                    const selectedOption = select.options[select.selectedIndex];
                    
                    // Если введенный текст не совпадает с выбранной опцией, пытаемся найти совпадение
                    if (searchTerm && selectedOption && selectedOption.textContent.toLowerCase() !== searchTerm.toLowerCase()) {
                        let found = false;
                        Array.from(select.options).forEach(function(option) {
                            if (option.value && !found) {
                                if (option.textContent.toLowerCase() === searchTerm.toLowerCase() || 
                                    option.value.toLowerCase() === searchTerm.toLowerCase()) {
                                    select.value = option.value;
                                    searchInput.value = option.textContent;
                                    found = true;
                                }
                            }
                        });
                        
                        // Если не нашли точного совпадения, оставляем текущее значение
                        if (!found && selectedOption && selectedOption.value) {
                            searchInput.value = selectedOption.textContent;
                        }
                    } else if (selectedOption && selectedOption.value) {
                        // Обновляем текст в поле ввода на основе выбранной опции
                        searchInput.value = selectedOption.textContent;
                    }
                    
                    dropdown.classList.remove('show');
                }, 200);
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !select.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
            
            select.addEventListener('change', function() {
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption) {
                    searchInput.value = selectedOption.textContent;
                }
                if (selectId === 'workflow_id') {
                    loadWorkflowInputs();
                }
            });
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption) {
                searchInput.value = selectedOption.textContent;
            }
        }
        
        // Функция для загрузки workflow inputs
        async function loadWorkflowInputs() {
            const owner = document.getElementById('owner').value.trim();
            const repo = document.getElementById('repo').value.trim();
            const workflowId = document.getElementById('workflow_id').value.trim();
            const inputsContainer = document.getElementById('workflow-inputs');
            const inputsWrapper = document.getElementById('workflow-inputs-wrapper');
            
            if (!owner || !repo || !workflowId || !inputsContainer || !inputsWrapper) {
                inputsContainer.innerHTML = '';
                inputsWrapper.style.display = 'none';
                return;
            }
            
            try {
                inputsWrapper.style.display = 'block';
                inputsContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>Loading workflow parameters...</span></div>';
                
                const response = await fetch(`/api/workflow-info?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&workflow_id=${encodeURIComponent(workflowId)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const inputs = data.inputs || {};
                    
                    if (Object.keys(inputs).length === 0) {
                        inputsContainer.innerHTML = '';
                        inputsWrapper.style.display = 'none';
                        return;
                    }
                    
                    let html = '';
                    for (const [inputName, inputConfig] of Object.entries(inputs)) {
                        const isRequired = inputConfig.required || false;
                        const defaultValue = inputConfig.default;
                        const description = inputConfig.description || '';
                        
                        html += '<div class="form-group">';
                        html += `<div class="field-header">`;
                        html += `<label for="input_${inputName}">${inputName}</label>`;
                        if (!isRequired) {
                            html += `<span class="optional">Optional</span>`;
                        }
                        html += `</div>`;
                        
                        if (inputConfig.type === 'choice') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value=""></option>';
                            }
                            for (const option of inputConfig.options || []) {
                                html += `<option value="${option}" ${option === defaultValue ? 'selected' : ''}>${option}</option>`;
                            }
                            html += '</select>';
                        } else if (inputConfig.type === 'boolean') {
                            html += `<div class="checkbox-wrapper">`;
                            html += `<label class="checkbox-label">`;
                            html += `<input type="checkbox" id="input_${inputName}" name="${inputName}" value="true" ${defaultValue ? 'checked' : ''}>`;
                            html += `<span>${inputName}</span>`;
                            html += `</label>`;
                            html += `</div>`;
                        } else if (inputConfig.type === 'environment') {
                            html += `<select id="input_${inputName}" name="${inputName}" class="form-select" ${isRequired ? 'required' : ''}>`;
                            if (!isRequired) {
                                html += '<option value=""></option>';
                            }
                            for (const env of ['production', 'staging', 'development', 'test']) {
                                html += `<option value="${env}" ${env === defaultValue ? 'selected' : ''}>${env}</option>`;
                            }
                            html += '</select>';
                        } else {
                            html += `<input type="text" id="input_${inputName}" name="${inputName}" value="${defaultValue || ''}" placeholder="" class="form-input" ${isRequired ? 'required' : ''}>`;
                        }
                        
                        // Добавляем description серым текстом под полем, если есть
                        if (description) {
                            html += `<small style="color: #9ca3af; font-size: 12px; margin-top: 4px; display: block;">${description}</small>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    inputsContainer.innerHTML = html;
                    inputsWrapper.style.display = 'block';
                } else {
                    // Ошибка от сервера
                    const errorText = await response.text();
                    let errorMessage = 'Failed to load workflow parameters';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    inputsContainer.innerHTML = `<div class="error-state">${errorMessage}</div>`;
                    inputsWrapper.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load workflow inputs:', error);
                inputsContainer.innerHTML = `<div class="error-state">Failed to load workflow parameters: ${error.message}</div>`;
                inputsWrapper.style.display = 'block';
            }
        }
        
        // Функция для загрузки branches и workflows
        async function loadBranchesAndWorkflows(owner, repo) {
            if (!owner || !repo) return;
            
            const branchLoader = document.getElementById('branch-loader');
            const workflowLoader = document.getElementById('workflow-loader');
            
            // Показываем спиннеры
            if (branchLoader) branchLoader.style.display = 'flex';
            if (workflowLoader) workflowLoader.style.display = 'flex';
            
            try {
                // Формируем URL для branches (без env параметра, фильтрация из конфига)
                const branchesUrl = `/api/branches?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`;
                
                const [branchesResponse, workflowsResponse] = await Promise.all([
                    fetch(branchesUrl),
                    fetch(`/api/workflows?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`)
                ]);
                
                if (branchesResponse.ok) {
                    const branchesData = await branchesResponse.json();
                    updateSelect('ref', branchesData.branches, 'main');
                    initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
                }
                
                if (workflowsResponse.ok) {
                    const workflowsData = await workflowsResponse.json();
                    updateSelect('workflow_id', workflowsData.workflows.map(w => ({id: w.id, name: w.name})), null);
                    initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
                    // Загружаем inputs для выбранного workflow
                    loadWorkflowInputs();
                }
            } catch (error) {
                console.error('Failed to load branches/workflows:', error);
            } finally {
                // Скрываем спиннеры
                if (branchLoader) branchLoader.style.display = 'none';
                if (workflowLoader) workflowLoader.style.display = 'none';
            }
        }
        
        // Функция для обновления select
        function updateSelect(selectId, items, defaultValue) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '';
            
            items.forEach(function(item) {
                const option = document.createElement('option');
                if (typeof item === 'string') {
                    option.value = item;
                    option.textContent = item;
                } else {
                    option.value = item.id;
                    option.textContent = `${item.id} - ${item.name}`;
                    option.setAttribute('data-name', item.name);
                }
                if ((defaultValue && item === defaultValue) || (defaultValue && item.id === defaultValue) || (currentValue && (item === currentValue || item.id === currentValue))) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            if (!select.value && items.length > 0) {
                if (defaultValue) {
                    const defaultOption = Array.from(select.options).find(opt => opt.value === defaultValue);
                    if (defaultOption) {
                        defaultOption.selected = true;
                    } else if (select.options.length > 0) {
                        select.options[0].selected = true;
                    }
                } else if (select.options.length > 0) {
                    select.options[0].selected = true;
                }
            }
        }
        
        // Обработка поля Repository (owner/repo)
        function setupRepositoryField() {
            const repositoryInput = document.getElementById('repository');
            const ownerInput = document.getElementById('owner');
            const repoInput = document.getElementById('repo');
            
            if (!repositoryInput || !ownerInput || !repoInput) return;
            
            let loadTimeout;
            
            function updateOwnerRepo() {
                const value = repositoryInput.value.trim();
                const parts = value.split('/');
                
                if (parts.length >= 2) {
                    const owner = parts[0].trim();
                    const repo = parts.slice(1).join('/').trim(); // На случай если repo содержит /
                    ownerInput.value = owner;
                    repoInput.value = repo;
                    
                    clearTimeout(loadTimeout);
                    loadTimeout = setTimeout(function() {
                        if (owner && repo) {
                            loadBranchesAndWorkflows(owner, repo);
                        }
                    }, 500);
                }
            }
            
            repositoryInput.addEventListener('input', updateOwnerRepo);
            repositoryInput.addEventListener('blur', updateOwnerRepo);
            
            // Инициализация при загрузке
            if (ownerInput.value && repoInput.value) {
                repositoryInput.value = `${ownerInput.value}/${repoInput.value}`;
                if (ownerInput.value && repoInput.value) {
                    loadBranchesAndWorkflows(ownerInput.value, repoInput.value);
                }
            }
        }
        
        // Валидация формы перед отправкой
        function setupFormValidation() {
            const form = document.getElementById('workflowForm');
            if (!form) return;
            
            form.addEventListener('submit', function(e) {
                const repositoryInput = document.getElementById('repository');
                const ownerInput = document.getElementById('owner');
                const repoInput = document.getElementById('repo');
                
                if (!repositoryInput || !ownerInput || !repoInput) {
                    e.preventDefault();
                    alert('Please enter a valid repository (owner/repo)');
                    return false;
                }
                
                const value = repositoryInput.value.trim();
                const parts = value.split('/');
                
                if (parts.length < 2 || !parts[0].trim() || !parts.slice(1).join('/').trim()) {
                    e.preventDefault();
                    alert('Please enter a valid repository in format: owner/repo');
                    return false;
                }
                
                // Обновляем hidden поля перед отправкой
                const owner = parts[0].trim();
                const repo = parts.slice(1).join('/').trim();
                ownerInput.value = owner;
                repoInput.value = repo;
            });
        }
        
        // Функция для копирования ссылки на запуск
        function setupCopyRunButton() {
            const copyBtn = document.getElementById('copy-run-btn');
            if (!copyBtn) {
                console.warn('Copy run button not found');
                return;
            }
            
            copyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const ownerInput = document.getElementById('owner');
                const repoInput = document.getElementById('repo');
                const workflowIdSelect = document.getElementById('workflow_id');
                const refSelect = document.getElementById('ref');
                
                console.log('Copy button clicked', { ownerInput, repoInput, workflowIdSelect, refSelect });
                
                if (!ownerInput || !repoInput || !workflowIdSelect || !refSelect) {
                    alert('Please fill in repository, workflow and branch');
                    return;
                }
                
                const owner = ownerInput.value.trim();
                const repo = repoInput.value.trim();
                const workflowId = workflowIdSelect.value.trim();
                const ref = refSelect.value.trim();
                
                console.log('Values:', { owner, repo, workflowId, ref });
                
                if (!owner || !repo || !workflowId || !ref) {
                    alert('Please fill in repository, workflow and branch');
                    return;
                }
                
                // Формируем URL для trigger
                const baseUrl = window.location.origin;
                const params = new URLSearchParams({
                    owner: owner,
                    repo: repo,
                    workflow_id: workflowId,
                    ref: ref
                });
                
                // Добавляем все inputs из формы
                const form = document.getElementById('workflowForm');
                if (form) {
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        // Пропускаем служебные поля
                        if (!['owner', 'repo', 'workflow_id', 'ref'].includes(key) && value) {
                            params.append(key, value);
                        }
                    }
                }
                
                const triggerUrl = `${baseUrl}/workflow/trigger?${params.toString()}`;
                
                console.log('Generated URL:', triggerUrl);
                
                // Копируем в буфер обмена
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(triggerUrl).then(function() {
                    // Показываем уведомление
                    const originalText = copyBtn.textContent;
                    const originalOpacity = copyBtn.style.opacity;
                    copyBtn.textContent = 'Copied!';
                    copyBtn.style.background = '#10b981';
                    copyBtn.style.color = '#fff';
                    copyBtn.style.opacity = '1';
                    copyBtn.style.borderColor = '#10b981';
                    
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#f9fafb';
                        copyBtn.style.color = '#6b7280';
                        copyBtn.style.opacity = originalOpacity || '0.6';
                        copyBtn.style.borderColor = '#d1d5db';
                    }, 2000);
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                        // Fallback: показываем URL в prompt
                        prompt('Copy this URL:', triggerUrl);
                    });
                } else {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = triggerUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        const originalText = copyBtn.textContent;
                        const originalOpacity = copyBtn.style.opacity;
                        copyBtn.textContent = 'Copied!';
                        copyBtn.style.background = '#10b981';
                        copyBtn.style.color = '#fff';
                        copyBtn.style.opacity = '1';
                        copyBtn.style.borderColor = '#10b981';
                        
                        setTimeout(function() {
                            copyBtn.textContent = originalText;
                            copyBtn.style.background = '#f9fafb';
                            copyBtn.style.color = '#6b7280';
                            copyBtn.style.opacity = originalOpacity || '0.6';
                            copyBtn.style.borderColor = '#d1d5db';
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        prompt('Copy this URL:', triggerUrl);
                    }
                    document.body.removeChild(textArea);
                }
            });
        }
        
        // Инициализация при загрузке
        function initAll() {
            initSearchableSelect('workflow_search', 'workflow_id', 'workflow_dropdown');
            initSearchableSelect('branch_search', 'ref', 'branch_dropdown');
            setupRepositoryField();
            setupFormValidation();
            setupCopyRunButton();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }
    </script>
</body>
</html>
