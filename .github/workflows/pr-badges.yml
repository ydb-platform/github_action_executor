name: Add PR Badges

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  add-badges:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    env:
      APP_DOMAIN: ${{ vars.APP_DOMAIN != '' && vars.APP_DOMAIN || 'http://localhost:8000' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check if badge comment already exists
        id: check_comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const badgeComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('▶ Run Tests') || comment.body.includes('Run Tests (Direct)')) &&
              (comment.body.includes('▶ Backport') || comment.body.includes('Backport (Direct)'))
            );
            
            core.setOutput('comment_id', badgeComment ? badgeComment.id : '');
            core.setOutput('exists', badgeComment ? 'true' : 'false');

      - name: Generate badge comment
        id: generate_comment
        run: |
          # Create vars JSON file
          cat > vars.json << EOF
          {
            "app_domain": "${{ env.APP_DOMAIN }}",
            "repo_owner": "${{ github.repository_owner }}",
            "repo_name": "${{ github.event.repository.name }}",
            "pr_number": ${{ github.event.pull_request.number }},
            "pr_branch": "${{ github.event.pull_request.head.ref }}",
            "base_branch": "${{ github.event.pull_request.base.ref }}"
          }
          EOF
          
          # Build comment using wrapper script
          python3 .github/scripts/badges/generate_markdown.py \
            --config .github/scripts/badges/configs/badge_config.json \
            --vars vars.json \
            --output comment.txt
          
          echo "comment_file=comment.txt" >> $GITHUB_OUTPUT

      - name: Add badge comment
        if: steps.check_comment.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const comment = fs.readFileSync('${{ steps.generate_comment.outputs.comment_file }}', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Update existing badge comment
        if: steps.check_comment.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const commentId = parseInt('${{ steps.check_comment.outputs.comment_id }}');
            const comment = fs.readFileSync('${{ steps.generate_comment.outputs.comment_file }}', 'utf8');
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: comment
            });
