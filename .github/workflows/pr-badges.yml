name: Add PR Badges

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  add-badges:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    env:
      APP_DOMAIN: ${{ vars.APP_DOMAIN != '' && vars.APP_DOMAIN || 'http://localhost:8000' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Read backport branches config
        id: read_config
        run: |
          if [ -f ".github/configs/backport_branches.json" ]; then
            cat .github/configs/backport_branches.json
          else
            echo '["release/v1.0"]'  # Default fallback
          fi > backport_branches.json
          echo "branches_file=backport_branches.json" >> $GITHUB_OUTPUT

      - name: Check if badge comment already exists
        id: check_comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const badgeComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('‚ñ∂ Run Tests') || comment.body.includes('Run Tests (Direct)')) &&
              (comment.body.includes('‚ñ∂ Backport') || comment.body.includes('Backport (Direct)'))
            );
            
            core.setOutput('comment_id', badgeComment ? badgeComment.id : '');
            core.setOutput('exists', badgeComment ? 'true' : 'false');

      - name: Add or update badge comment
        if: steps.check_comment.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const prBranch = context.payload.pull_request.head.ref;
            const baseBranch = context.payload.pull_request.base.ref;
            
            // Get app domain from environment variable
            // Set APP_DOMAIN in: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables
            let appDomain = process.env.APP_DOMAIN && process.env.APP_DOMAIN.trim() !== '' 
              ? process.env.APP_DOMAIN.trim() 
              : 'http://localhost:8000';
            // Remove trailing slash to avoid double slashes in URL
            appDomain = appDomain.replace(/\/+$/, '');
            
            // Read backport branches from config file
            let backportBranches = ['release/v1.0']; // Default fallback
            try {
              const configContent = fs.readFileSync('backport_branches.json', 'utf8');
              backportBranches = JSON.parse(configContent);
            } catch (error) {
              console.log('Failed to read backport_branches.json, using default:', error.message);
            }
            
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            // Build URLs for test workflow
            const testUrlDirect = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=test.yml&ref=${baseBranch}&pr_branch=${prBranch}&test_type=all&from_pr=${prNumber}`;
            const testUrlUI = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=test.yml&ref=${baseBranch}&pr_branch=${prBranch}&test_type=all&from_pr=${prNumber}&ui=true`;
            
            // Build backport table with buttons for each branch
            let backportTable = '| Branch | Actions |\n|--------|---------|\n';
            for (const targetBranch of backportBranches) {
              const backportUrlDirect = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=backport.yml&ref=${baseBranch}&source_branch=${prBranch}&target_branch=${targetBranch}&from_pr=${prNumber}`;
              const backportUrlUI = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=backport.yml&ref=${baseBranch}&source_branch=${prBranch}&target_branch=${targetBranch}&from_pr=${prNumber}&ui=true`;
              
              backportTable += `| \`${targetBranch}\` | ` +
                `[![‚ñ∂ Backport](https://img.shields.io/badge/‚ñ∂_Backport-2196f3?style=flat-square)](${backportUrlDirect}) ` +
                `[![‚öôÔ∏è](https://img.shields.io/badge/‚öôÔ∏è-ff9800?style=flat-square)](${backportUrlUI}) |\n`;
            }
            
            const comment = '## üöÄ Quick Actions\n\n' +
              'Use these buttons to quickly run workflows for this PR:\n\n' +
              '### üß™ Run Tests\n' +
              `[![‚ñ∂ Run Tests](https://img.shields.io/badge/‚ñ∂_Run_Tests-4caf50?style=flat-square)](${testUrlDirect}) ` +
              `[![‚öôÔ∏è](https://img.shields.io/badge/‚öôÔ∏è-ff9800?style=flat-square)](${testUrlUI})\n\n` +
              '### üì¶ Backport\n\n' +
              backportTable + '\n' +
              '‚ñ∂ - immediately runs the workflow with default parameters.\n' +
              '‚öôÔ∏è - opens UI to review and modify parameters before running.\n\n' +
              '---\n' +
              '*These links will automatically comment on this PR with the workflow results.*';

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Update existing badge comment
        if: steps.check_comment.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const prBranch = context.payload.pull_request.head.ref;
            const baseBranch = context.payload.pull_request.base.ref;
            const commentId = parseInt('${{ steps.check_comment.outputs.comment_id }}');
            
            // Get app domain from environment variable
            // Set APP_DOMAIN in: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables
            let appDomain = process.env.APP_DOMAIN && process.env.APP_DOMAIN.trim() !== '' 
              ? process.env.APP_DOMAIN.trim() 
              : 'http://localhost:8000';
            // Remove trailing slash to avoid double slashes in URL
            appDomain = appDomain.replace(/\/+$/, '');
            
            // Read backport branches from config file
            let backportBranches = ['release/v1.0']; // Default fallback
            try {
              const configContent = fs.readFileSync('backport_branches.json', 'utf8');
              backportBranches = JSON.parse(configContent);
            } catch (error) {
              console.log('Failed to read backport_branches.json, using default:', error.message);
            }
            
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            // Build URLs for test workflow
            const testUrlDirect = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=test.yml&ref=${baseBranch}&pr_branch=${prBranch}&test_type=all&from_pr=${prNumber}`;
            const testUrlUI = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=test.yml&ref=${baseBranch}&pr_branch=${prBranch}&test_type=all&from_pr=${prNumber}&ui=true`;
            
            // Build backport table with buttons for each branch
            let backportTable = '| Branch | Actions |\n|--------|---------|\n';
            for (const targetBranch of backportBranches) {
              const backportUrlDirect = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=backport.yml&ref=${baseBranch}&source_branch=${prBranch}&target_branch=${targetBranch}&from_pr=${prNumber}`;
              const backportUrlUI = `${appDomain}/workflow/trigger?owner=${repoOwner}&repo=${repoName}&workflow_id=backport.yml&ref=${baseBranch}&source_branch=${prBranch}&target_branch=${targetBranch}&from_pr=${prNumber}&ui=true`;
              
              backportTable += `| \`${targetBranch}\` | ` +
                `[![‚ñ∂ Backport](https://img.shields.io/badge/‚ñ∂_Backport-2196f3?style=flat-square)](${backportUrlDirect}) ` +
                `[![‚öôÔ∏è](https://img.shields.io/badge/‚öôÔ∏è-ff9800?style=flat-square)](${backportUrlUI}) |\n`;
            }
            
            const comment = '## üöÄ Quick Actions\n\n' +
              'Use these buttons to quickly run workflows for this PR:\n\n' +
              '### üß™ Run Tests\n' +
              `[![‚ñ∂ Run Tests](https://img.shields.io/badge/‚ñ∂_Run_Tests-4caf50?style=flat-square)](${testUrlDirect}) ` +
              `[![‚öôÔ∏è](https://img.shields.io/badge/‚öôÔ∏è-ff9800?style=flat-square)](${testUrlUI})\n\n` +
              '### üì¶ Backport\n\n' +
              backportTable + '\n' +
              '‚ñ∂ - immediately runs the workflow with default parameters.\n' +
              '‚öôÔ∏è - opens UI to review and modify parameters before running.\n\n' +
              '---\n' +
              '*These links will automatically comment on this PR with the workflow results.*';

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: comment
            });

