name: Backport

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to backport from (e.g., main, develop)'
        required: true
        type: string
        default: 'main'
      target_branch:
        description: 'Target branch to backport to (e.g., release/v1.0, stable)'
        required: true
        type: string
      commit_sha:
        description: 'Specific commit SHA to backport (optional, if empty - backport all commits)'
        required: false
        type: string
      from_pr:
        description: 'PR number to comment on (optional)'
        required: false
        type: string

jobs:
  backport:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Comment on PR (started)
        if: inputs.from_pr != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ inputs.from_pr }}');
            const sourceBranch = '${{ inputs.source_branch }}';
            const targetBranch = '${{ inputs.target_branch }}';
            const workflowRunUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const comment = `üîÑ **Backport started**
            
            - Source: \`${sourceBranch}\`
            - Target: \`${targetBranch}\`
            - Workflow run: [View run](${workflowRunUrl})
            - Status: ‚è≥ In progress...`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check if target branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin "${{ inputs.target_branch }}" | grep -q "${{ inputs.target_branch }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Target branch ${{ inputs.target_branch }} exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Target branch ${{ inputs.target_branch }} does not exist, will be created"
          fi

      - name: Create target branch if not exists
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          git checkout -b "${{ inputs.target_branch }}" origin/"${{ inputs.source_branch }}"
          git push origin "${{ inputs.target_branch }}"

      - name: Checkout target branch
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          git checkout "${{ inputs.target_branch }}"
          git pull origin "${{ inputs.target_branch }}"

      - name: Backport specific commit
        if: inputs.commit_sha != ''
        id: backport_specific
        run: |
          echo "Backporting commit ${{ inputs.commit_sha }}"
          # Create a branch name for the PR
          BACKPORT_BRANCH="backport/${{ inputs.target_branch }}-$(date +%s)"
          git checkout -b "$BACKPORT_BRANCH" "${{ inputs.target_branch }}"
          
          # Cherry-pick the commit
          git cherry-pick "${{ inputs.commit_sha }}" || {
            echo "Cherry-pick failed, this might be due to conflicts"
            exit 1
          }
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "backport_branch=$BACKPORT_BRANCH" >> $GITHUB_OUTPUT

      - name: Backport all commits from source branch
        if: inputs.commit_sha == ''
        id: backport_all
        run: |
          echo "Backporting all commits from ${{ inputs.source_branch }} to ${{ inputs.target_branch }}"
          # Get commits that are in source but not in target
          COMMITS=$(git log origin/"${{ inputs.target_branch }}"..origin/"${{ inputs.source_branch }}" --oneline | wc -l)
          echo "Found $COMMITS commits to backport"
          
          if [ "$COMMITS" -eq 0 ]; then
            echo "No commits to backport"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create a branch name for the PR
          BACKPORT_BRANCH="backport/${{ inputs.target_branch }}-$(date +%s)"
          git checkout -b "$BACKPORT_BRANCH" "${{ inputs.target_branch }}"
          
          # Cherry-pick all commits
          git cherry-pick origin/"${{ inputs.target_branch }}"..origin/"${{ inputs.source_branch }}" || {
            echo "Cherry-pick failed, this might be due to conflicts"
            exit 1
          }
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "backport_branch=$BACKPORT_BRANCH" >> $GITHUB_OUTPUT

      - name: Create PR for backport
        if: |
          (inputs.commit_sha != '' && steps.backport_specific.outputs.has_changes == 'true') ||
          (inputs.commit_sha == '' && steps.backport_all.outputs.has_changes == 'true')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceBranch = '${{ inputs.source_branch }}';
            const targetBranch = '${{ inputs.target_branch }}';
            const commitSha = '${{ inputs.commit_sha }}';
            const prNumber = '${{ inputs.from_pr }}';
            
            // Get backport branch name from previous step
            const backportBranch = '${{ inputs.commit_sha != '' && steps.backport_specific.outputs.backport_branch || steps.backport_all.outputs.backport_branch }}';
            
            // Push the backport branch
            const { execSync } = require('child_process');
            execSync(`git push origin ${backportBranch}`, { stdio: 'inherit' });
            
            // Create PR
            const prTitle = `Backport to ${targetBranch}`;
            let prBody = `This PR backports changes to \`${targetBranch}\` branch.\n\n`;
            
            if (commitSha) {
              prBody += `- Commit: \`${commitSha.substring(0, 7)}\`\n`;
            } else {
              prBody += `- Source branch: \`${sourceBranch}\`\n`;
            }
            
            prBody += `- Target branch: \`${targetBranch}\`\n\n`;
            prBody += `*This PR was created automatically by the backport workflow.*`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              body: prBody,
              head: backportBranch,
              base: targetBranch,
            });
            
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);
            
            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
            
            // Comment on original PR if from_pr is set
            if (prNumber && prNumber !== '') {
              const originalPrNumber = parseInt(prNumber);
              const comment = `‚úÖ **Backport PR created!**
              
              - PR: #${pr.data.number}
              - Link: ${pr.data.html_url}
              - Target: \`${targetBranch}\``;
              
              await github.rest.issues.createComment({
                issue_number: originalPrNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Comment on PR (success)
        if: success() && inputs.from_pr != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ inputs.from_pr }}');
            const sourceBranch = '${{ inputs.source_branch }}';
            const targetBranch = '${{ inputs.target_branch }}';
            const commitSha = '${{ inputs.commit_sha }}';
            const workflowRunUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            let backportInfo = '';
            if (commitSha) {
              backportInfo = `- Commit: \`${commitSha.substring(0, 7)}\``;
            } else {
              backportInfo = `- All commits from \`${sourceBranch}\``;
            }
            
            const comment = `‚úÖ **Backport completed successfully!**
            
            - Source: \`${sourceBranch}\`
            - Target: \`${targetBranch}\`
            ${backportInfo}
            - Workflow run: [View run](${workflowRunUrl})
            - Status: ‚úÖ Success`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR (failure)
        if: failure() && inputs.from_pr != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ inputs.from_pr }}');
            const sourceBranch = '${{ inputs.source_branch }}';
            const targetBranch = '${{ inputs.target_branch }}';
            const workflowRunUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const comment = `‚ùå **Backport failed!**
            
            - Source: \`${sourceBranch}\`
            - Target: \`${targetBranch}\`
            - Workflow run: [View run](${workflowRunUrl})
            - Status: ‚ùå Failed
            - Possible reasons: merge conflicts or branch protection rules`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

